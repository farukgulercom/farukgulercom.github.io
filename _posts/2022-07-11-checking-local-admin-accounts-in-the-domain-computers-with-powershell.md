---
layout: post
title: Checking local admin accounts in the domain computers with Powershell
date: 2022-07-11 14:59
author: theguler
comments: true
categories: [PowerShell]
---
<!-- wp:image {"id":4474,"width":"257px","height":"auto","sizeSlug":"large","linkDestination":"none"} -->
<figure class="wp-block-image size-large is-resized"><img src="https://theguler.wordpress.com/wp-content/uploads/2022/09/slim_powershell.jpg?w=600" alt="" class="wp-image-4474" style="width:257px;height:auto" /></figure>
<!-- /wp:image -->

<!-- wp:preformatted -->
<pre class="wp-block-preformatted">Import-Module activedirectory<br><br>Get-LocalAdminToCsv -Path "OU=Server,DC=guler,DC=com" #Spesific OU<br>#Get-LocalAdminToCsv -ComputerName PC1,PC2,PC3 #Spesific Computer<br>#Get-localAdmintoCSV #All Domain<br><br>function Get-LocalAdminToCsv {<br>    Param(<br>            $Path          = (Get-ADDomain).DistinguishedName,   <br>            $ComputerName  = (Get-ADComputer -Filter * -Server (Get-ADDomain).DNsroot -SearchBase $Path -Properties Enabled | Where-Object {$_.Enabled -eq "True"})<br>         )<br><br>    begin{<br>        [array]$Table = $null<br>        $Counter = 0<br>         }<br>    <br>    process<br>       {<br>    $Date       = Get-Date -Format MM_dd_yyyy_HH_mm_ss<br>    $FolderName = "LocalAdminsReport("+ $Date + ")"<br>    New-Item -Path ".\$FolderName" -ItemType Directory -Force | Out-Null<br><br>        foreach($Computer in $ComputerName)<br>        {<br>            try<br>            {<br>                $PC      = Get-ADComputer $Computer<br>                $Name    = $PC.Name<br>                $CountPC = @($ComputerName).count<br>            }<br><br>            catch<br>            {<br>                Write-Host "Cannot retrieve computer $Computer" -ForegroundColor Yellow -BackgroundColor Red<br>                Add-Content -Path "C:\Cannot_Comp.txt" "$Name"<br>                continue<br>            }<br><br>            finally<br>            {<br>                $Counter ++<br>            }<br><br>            Write-Progress -Activity "Connecting PC $Counter/$CountPC " -Status "Querying ($Name)" -PercentComplete (($Counter/$CountPC) * 100)<br><br>            try<br>            {<br>                $row = $null<br>                $members =[ADSI]"WinNT://$Name/Administrators"<br>                $members = @($members.psbase.Invoke("Members"))<br>                $members | foreach {<br>                            $User = $_.GetType().InvokeMember("Name", 'GetProperty', $null, $_, $null)<br>                                    $row += $User<br>                                    $row += " ; "<br>                                    }<br>                write-host "Computer ($Name) has been queried and exported." -ForegroundColor Green -BackgroundColor black <br>                <br>                $obj = New-Object -TypeName PSObject -Property @{<br>                                "Name"           = $Name<br>                                "LocalAdmins"    = $Row<br>                                                    }<br>                $Table += $obj<br>            }<br><br>            catch<br>            {<br>            Write-Host "Error accessing ($Name)" -ForegroundColor Yellow -BackgroundColor Red<br>            Add-Content -Path "C:\Access_Err.txt" "$Name"<br>            }<br><br>            <br>        }<br>        try<br>        {<br>            $Table  | Sort Name | Select Name,LocalAdmins | Export-Csv -path "C:\Report_adm.csv" -Append -NoTypeInformation<br>        }<br>        catch<br>        {<br>            Write-Warning $_<br>        }<br>    }<br><br>    end{}<br>   }</pre>
<!-- /wp:preformatted -->
